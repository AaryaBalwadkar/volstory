name: VolStory CI

# Trigger the robot on:
# 1. Pushes to main or develop (to keep history clean)
# 2. Any Pull Request (to catch bugs before merging)
on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: Quality Check (Linting & Types)
  quality-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Generate Expo Types
        # CRITICAL for Expo Router + TypeScript
        # This creates the hidden .expo folder so standard 'tsc' doesn't fail
        run: npx expo customize tsconfig.json

      - name: Check TypeScript Types
        # Runs tsc to ensure no type errors exist
        run: npm run type-check

      - name: Run Linter
        # Runs ESLint to check for code style violations
        run: npm run lint

  # Job 2: Unit Testing
  test-suite:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality-check # Wait for Linting to pass first (save minutes)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Jest Tests
        # Runs tests and prevents the job from hanging
        run: npm test -- --passWithNoTests --ci --maxWorkers=2

  # Job 3: Build Verification (Optional but Recommended)
  # This checks if the app can actually compile without crashing EAS
  build-check:
    name: dry-run-build
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Run Expo Doctor
        # Checks for incompatible package versions
        run: npx expo-doctor